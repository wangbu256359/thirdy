{"version":3,"file":"RenewOnTabActivationService.js","names":["getNow","Math","floor","Date","now","RenewOnTabActivationService","constructor","tokenManager","options","onPageVisbilityChange","_onPageVisbilityChange","bind","document","hidden","lastHidden","tabInactivityDuration","accessToken","idToken","getTokensSync","hasExpired","key","getStorageKeyByType","renew","catch","start","canStart","addEventListener","started","stop","removeEventListener","isBrowser","autoRenew","renewOnTabActivation","requiresLeadership","isStarted"],"sources":["../../../lib/services/RenewOnTabActivationService.ts"],"sourcesContent":["import { ServiceInterface, ServiceManagerOptions } from '../core/types';\nimport { TokenManagerInterface } from '../oidc/types';\nimport { isBrowser } from '../features';\n\nconst getNow = () => Math.floor(Date.now() / 1000);\n\nexport class RenewOnTabActivationService implements ServiceInterface {\n  private tokenManager: TokenManagerInterface;\n  private started = false;\n  private options: ServiceManagerOptions;\n  private lastHidden = -1;\n  onPageVisbilityChange: () => void;\n\n  constructor(tokenManager: TokenManagerInterface, options: ServiceManagerOptions = {}) {\n    this.tokenManager = tokenManager;\n    this.options = options;\n    // store this context for event handler\n    this.onPageVisbilityChange = this._onPageVisbilityChange.bind(this);\n  }\n\n  // do not use directly, use `onPageVisbilityChange` (with binded this context)\n  /* eslint complexity: [0, 10] */\n  private _onPageVisbilityChange () {\n    if (document.hidden) {\n      this.lastHidden = getNow();\n    }\n    // renew will only attempt if tab was inactive for duration\n    else if (this.lastHidden > 0 && (getNow() - this.lastHidden >= this.options.tabInactivityDuration!)) {\n      const { accessToken, idToken } = this.tokenManager.getTokensSync();\n      if (!!accessToken && this.tokenManager.hasExpired(accessToken)) {\n        const key = this.tokenManager.getStorageKeyByType('accessToken');\n        // Renew errors will emit an \"error\" event\n        this.tokenManager.renew(key).catch(() => {});\n      }\n      else if (!!idToken && this.tokenManager.hasExpired(idToken)) {\n        const key = this.tokenManager.getStorageKeyByType('idToken');\n        // Renew errors will emit an \"error\" event\n        this.tokenManager.renew(key).catch(() => {});\n      }\n    }\n  }\n\n  async start () {\n    if (this.canStart() && !!document) {\n      document.addEventListener('visibilitychange', this.onPageVisbilityChange);\n      this.started = true;\n    }\n  }\n\n  async stop () {\n    if (document) {\n      document.removeEventListener('visibilitychange', this.onPageVisbilityChange);\n      this.started = false;\n    }\n  }\n\n  canStart(): boolean {\n    return isBrowser() &&\n    !!this.options.autoRenew &&\n    !!this.options.renewOnTabActivation &&\n    !this.started;\n  }\n\n  requiresLeadership(): boolean {\n    return false;\n  }\n\n  isStarted(): boolean {\n    return this.started;\n  }\n}\n"],"mappings":";;;;;AAEA;AAEA,MAAMA,MAAM,GAAG,MAAMC,IAAI,CAACC,KAAK,CAACC,IAAI,CAACC,GAAG,EAAE,GAAG,IAAI,CAAC;AAE3C,MAAMC,2BAA2B,CAA6B;EAOnEC,WAAW,CAACC,YAAmC,EAAEC,OAA8B,GAAG,CAAC,CAAC,EAAE;IAAA,+CALpE,KAAK;IAAA,kDAEF,CAAC,CAAC;IAIrB,IAAI,CAACD,YAAY,GAAGA,YAAY;IAChC,IAAI,CAACC,OAAO,GAAGA,OAAO;IACtB;IACA,IAAI,CAACC,qBAAqB,GAAG,IAAI,CAACC,sBAAsB,CAACC,IAAI,CAAC,IAAI,CAAC;EACrE;;EAEA;EACA;EACQD,sBAAsB,GAAI;IAChC,IAAIE,QAAQ,CAACC,MAAM,EAAE;MACnB,IAAI,CAACC,UAAU,GAAGd,MAAM,EAAE;IAC5B;IACA;IAAA,KACK,IAAI,IAAI,CAACc,UAAU,GAAG,CAAC,IAAKd,MAAM,EAAE,GAAG,IAAI,CAACc,UAAU,IAAI,IAAI,CAACN,OAAO,CAACO,qBAAuB,EAAE;MACnG,MAAM;QAAEC,WAAW;QAAEC;MAAQ,CAAC,GAAG,IAAI,CAACV,YAAY,CAACW,aAAa,EAAE;MAClE,IAAI,CAAC,CAACF,WAAW,IAAI,IAAI,CAACT,YAAY,CAACY,UAAU,CAACH,WAAW,CAAC,EAAE;QAC9D,MAAMI,GAAG,GAAG,IAAI,CAACb,YAAY,CAACc,mBAAmB,CAAC,aAAa,CAAC;QAChE;QACA,IAAI,CAACd,YAAY,CAACe,KAAK,CAACF,GAAG,CAAC,CAACG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;MAC9C,CAAC,MACI,IAAI,CAAC,CAACN,OAAO,IAAI,IAAI,CAACV,YAAY,CAACY,UAAU,CAACF,OAAO,CAAC,EAAE;QAC3D,MAAMG,GAAG,GAAG,IAAI,CAACb,YAAY,CAACc,mBAAmB,CAAC,SAAS,CAAC;QAC5D;QACA,IAAI,CAACd,YAAY,CAACe,KAAK,CAACF,GAAG,CAAC,CAACG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;MAC9C;IACF;EACF;EAEA,MAAMC,KAAK,GAAI;IACb,IAAI,IAAI,CAACC,QAAQ,EAAE,IAAI,CAAC,CAACb,QAAQ,EAAE;MACjCA,QAAQ,CAACc,gBAAgB,CAAC,kBAAkB,EAAE,IAAI,CAACjB,qBAAqB,CAAC;MACzE,IAAI,CAACkB,OAAO,GAAG,IAAI;IACrB;EACF;EAEA,MAAMC,IAAI,GAAI;IACZ,IAAIhB,QAAQ,EAAE;MACZA,QAAQ,CAACiB,mBAAmB,CAAC,kBAAkB,EAAE,IAAI,CAACpB,qBAAqB,CAAC;MAC5E,IAAI,CAACkB,OAAO,GAAG,KAAK;IACtB;EACF;EAEAF,QAAQ,GAAY;IAClB,OAAO,IAAAK,mBAAS,GAAE,IAClB,CAAC,CAAC,IAAI,CAACtB,OAAO,CAACuB,SAAS,IACxB,CAAC,CAAC,IAAI,CAACvB,OAAO,CAACwB,oBAAoB,IACnC,CAAC,IAAI,CAACL,OAAO;EACf;EAEAM,kBAAkB,GAAY;IAC5B,OAAO,KAAK;EACd;EAEAC,SAAS,GAAY;IACnB,OAAO,IAAI,CAACP,OAAO;EACrB;AACF;AAAC"}